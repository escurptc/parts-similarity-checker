<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8" />
        <title>Similarity Matrix Tool</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 2rem;
                background-color: #f9f9f9;
                color: #333;
            }

            h1,
            h2 {
                color: #222;
                margin-top: 2rem;
            }

            button {
                margin: 0.5rem 0.5rem 1rem 0;
                padding: 0.5rem 1rem;
                font-size: 1rem;
                cursor: pointer;
                border: none;
                background-color: #007acc;
                color: white;
                border-radius: 4px;
            }

            button:hover {
                background-color: #1c02c9;
            }

            .delete-json {
                background-color: #e74c3c;
            }

            .delete-json:hover {
                background-color: #c0392b;
            }

            .json-block {
                display: flex;
                gap: 10px;
                margin-bottom: 1rem;
                align-items: flex-start;
            }

            .json-block textarea {
                flex: 1;
                height: 150px;
                font-family: monospace;
                padding: 0.5rem;
                border: 1px solid #ccc;
                border-radius: 4px;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 1rem;
            }

            th,
            td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: left;
            }

            thead {
                background-color: #eee;
            }

            #search-input {
                width: 300px;
                padding: 0.5rem;
                margin-bottom: 0.5rem;
                border: 1px solid #ccc;
                border-radius: 4px;
            }

            .autocomplete-items {
                position: absolute;
                background-color: white;
                border: 1px solid #ccc;
                max-height: 200px;
                overflow-y: auto;
                z-index: 1000;
                width: 300px;
            }

            .autocomplete-items div {
                padding: 8px;
                cursor: pointer;
            }

            .autocomplete-items div:hover {
                background-color: #f0f0f0;
            }

            button:disabled {
                background-color: #ccc !important;
                color: #666 !important;
                cursor: not-allowed;
                opacity: 0.6;
            }
        </style>
    </head>

    <body>
        <h1>Similarity Matrix Comparison</h1>
        <p>This tool helps compare the similarity between two parts across multiple results JSON objects to ensure
            similarity values are consistent.</p>

        <button id="add-json">‚ûï Add JSON</button>
        <button id="compare">üîç Compare</button>

        <div id="json-inputs">
            <div class="json-block">
                <textarea placeholder="Paste JSON here"></textarea>
                <span style="margin-left: 1rem; font-weight: bold;">minSimilarity:</span>
                <button class="delete-json"
                        style="background-color: #e74c3c;"
                        disabled>üóëÔ∏è Delete</button>
            </div>
        </div>


        <h2>Discrepancies</h2>
        <p>Pairs of parts with differing similarity values across JSONs:</p>
        <div id="discrepancies"></div>

        <h2>Search Comparison</h2>
        <p>Search for a part name to filter the similarity matrix:</p>
        <input type="text"
               id="search-input"
               placeholder="Type part name..."
               autocomplete="off" />
        <div id="autocomplete-list"
             class="autocomplete-items"></div>
        <button id="search-button">Search</button>
        <button id="reset-button">Reset</button>
        <div id="search-results"></div>

        <h2>Similarity Matrix</h2>
        <p>The full comparison table of similarity values:</p>
        <div id="results-table"></div>

        <script>
            const jsonInputs = document.getElementById("json-inputs");
            const addJsonBtn = document.getElementById("add-json");
            const compareBtn = document.getElementById("compare");
            const resultsTable = document.getElementById("results-table");
            const discrepanciesDiv = document.getElementById("discrepancies");
            const searchInput = document.getElementById("search-input");
            const searchButton = document.getElementById("search-button");
            const resetButton = document.getElementById("reset-button");
            const autocompleteList = document.getElementById("autocomplete-list");

            let jsons = [];
            let allPairs = new Set();
            let discrepancies = [];

            addJsonBtn.onclick = () => {
                const block = document.createElement("div");
                block.className = "json-block";

                const textarea = document.createElement("textarea");
                textarea.placeholder = "Paste JSON here";

                const minSimDisplay = document.createElement("span");
                minSimDisplay.style.marginLeft = "1rem";
                minSimDisplay.style.fontWeight = "bold";
                minSimDisplay.textContent = "minSimilarity:";

                block.appendChild(textarea);
                block.appendChild(minSimDisplay);

                const deleteBtn = document.createElement("button");
                deleteBtn.textContent = "üóëÔ∏è Delete";
                deleteBtn.className = "delete-json";
                deleteBtn.onclick = () => block.remove();
                block.appendChild(deleteBtn);

                jsonInputs.appendChild(block);
            };



            function extractSimilaritiesFromClusters(json) {
                const similarities = {};
                if (!json.clusters) return similarities;

                for (const cluster of json.clusters) {
                    const parts = cluster.parts.map(p => p.id);
                    const matrix = cluster.similarityMatrix;

                    for (let i = 0; i < matrix.length; i++) {
                        for (let j = 0; j < matrix[i].length; j++) {
                            const partA = parts[i];
                            const partB = parts[i + j + 1];
                            const key = [partA, partB].sort().join(" - ");
                            similarities[key] = matrix[i][j];
                        }
                    }
                }

                return similarities;
            }

            function renderSimilarityTable(pairsToShow) {
                let tableHTML = `
    <table>
      <thead>
        <tr>
          <th>Part 1</th>
          <th>Part 2</th>
          ${jsons.map((_, i) => `<th>Similarity in JSON ${i + 1}</th>`).join("")}
        </tr>
      </thead>
      <tbody>
  `;

                pairsToShow.forEach(pair => {
                    const [part1, part2] = pair.split(" - ");
                    const values = jsons.map(sim => sim[pair] ?? sim[`${part2} - ${part1}`] ?? "N/A");

                    tableHTML += `
      <tr>
        <td>${part1}</td>
        <td>${part2}</td>
        ${values.map(v => `<td>${v}</td>`).join("")}
      </tr>
    `;
                });

                tableHTML += `</tbody></table>`;
                resultsTable.innerHTML = tableHTML;
            }

            function renderDiscrepancyTable() {
                let discrepancyHTML = `
    <table>
      <thead>
        <tr>
          <th>Part 1</th>
          <th>Part 2</th>
          ${jsons.map((_, i) => `<th>Similarity in JSON ${i + 1}</th>`).join("")}
        </tr>
      </thead>
      <tbody>
  `;

                discrepancies.forEach(d => {
                    const [part1, part2] = d.pair.split(" - ");
                    discrepancyHTML += `
      <tr>
        <td>${part1}</td>
        <td>${part2}</td>
        ${d.values.map(v => `<td>${v}</td>`).join("")}
      </tr>
    `;
                });

                discrepancyHTML += `</tbody></table>`;
                discrepanciesDiv.innerHTML = discrepancyHTML;
            }

            compareBtn.onclick = () => {
                const textareas = jsonInputs.querySelectorAll("textarea");
                jsons = [];
                allPairs = new Set();
                discrepancies = [];

                for (const ta of textareas) {
                    try {
                        const parsed = JSON.parse(ta.value);
                        const simMap = extractSimilaritiesFromClusters(parsed);
                        jsons.push(simMap);

                        // Compute min similarity
                        const values = Object.values(simMap).map(v => parseFloat(v)).filter(v => !isNaN(v));
                        const minSim = values.length ? Math.min(...values).toFixed(4) : "N/A";

                        // Update the corresponding span
                        const span = ta.parentElement.querySelector("span");
                        if (span) span.textContent = `minSimilarity: ${minSim}`;
                    } catch (e) {
                        alert("Invalid JSON detected.");
                        return;
                    }
                }

                jsons.forEach(sim => {
                    Object.keys(sim).forEach(pair => {
                        allPairs.add(pair);
                    });
                });

                Array.from(allPairs).forEach(pair => {
                    const values = jsons.map(sim => sim[pair] ?? sim[pair.split(" - ").reverse().join(" - ")] ?? "N/A");

                    const numericValues = values.map(v => {
                        const num = typeof v === "number" ? v : parseFloat(v);
                        return isNaN(num) ? null : num;
                    }).filter(v => v !== null);

                    if (numericValues.length > 1) {
                        const max = Math.max(...numericValues);
                        const min = Math.min(...numericValues);
                        const diff = Math.abs(max - min);

                        if (diff > 0.001) {
                            discrepancies.push({ pair, values });
                        }
                    }
                });

                renderDiscrepancyTable();
                renderSimilarityTable(Array.from(allPairs));
            };


            function updateAutocompleteSuggestions(query) {
                autocompleteList.innerHTML = "";
                if (!query) return;

                const matches = Array.from(allPairs).flatMap(pair => pair.split(" - "))
                    .filter(part => part.toLowerCase().includes(query.toLowerCase()))
                    .filter((v, i, a) => a.indexOf(v) === i);

                matches.forEach(match => {
                    const item = document.createElement("div");
                    item.textContent = match;
                    item.onclick = () => {
                        searchInput.value = match;
                        autocompleteList.innerHTML = "";
                        searchButton.click();
                    };
                    autocompleteList.appendChild(item);
                });
            }

            searchInput.oninput = () => {
                updateAutocompleteSuggestions(searchInput.value.trim());
            };

            searchButton.onclick = () => {
                const query = searchInput.value.trim().toLowerCase();
                autocompleteList.innerHTML = "";

                if (!query) return;

                const filteredPairs = Array.from(allPairs).filter(pair =>
                    pair.toLowerCase().includes(query)
                );

                renderSimilarityTable(filteredPairs);
            };

            resetButton.onclick = () => {
                searchInput.value = "";
                autocompleteList.innerHTML = "";
                renderSimilarityTable(Array.from(allPairs));
            };
        </script>
